---

name: 'Workflow'

on:
  workflow_dispatch:
    inputs:
      runDev:
        description: 'Run Dev'
        required: true
        type: boolean
        default: true
      inOrder:
        description: 'Run in order'
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:

  first_job:
    name: First Job
    runs-on: ubuntu-latest
    outputs:
      matrix_order: ${{ steps.set_matrix.outputs.matrix }}
      matrix_max_parallel: ${{ steps.set_matrix.outputs.matrix_parallel }}
      matrix_fail_fast: ${{ steps.set_matrix.outputs.matrix_fail_fast }}
    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Create matrix order
      id: set_matrix
      run: |
        echo "input: ${{ github.event.inputs.inOrder }}"

        if [[ "${{ github.event.inputs.inOrder}}" == "true" ]]
        then
          matrix_parallel=1
          matrix_fail_fast="true"
        else
          matrix_parallel=2
          matrix_fail_fast="false"
        fi

        if [[ "${{ github.event.inputs.runDev }}" == "true" ]]
        then
          matrix='{"stage": ["dev","tst"]}'
        else
          matrix='{"stage": ["tst"]}'
        fi

        jq <<< "$matrix"
        echo "matrix_max_parallel=$matrix_max_parallel"
        echo "matrix_fail_fast=$matrix_fail_fast"

        echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
        echo "matrix_max_parallel=$matrix_max_parallel" >> "$GITHUB_OUTPUT"
        echo "matrix_fail_fast=$matrix_fail_fast" >> "$GITHUB_OUTPUT"

  second_job:
    name: 'Second Job'
    runs-on: ubuntu-latest
    needs: first_job
    strategy: ${{fromJson('{"matrix":{"stage":["dev","tst"]},"fail-fast":true,"max-parallel":1}')}}
    # strategy:
    #   matrix: ${{fromJson(needs.first_job.outputs.matrix_order)}}
    #   fail-fast: ${{needs.first_job.outputs.matrix_fail_fast}}
    #   max-parallel: ${{needs.first_job.outputs.matrix_max_parallel}}
    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Started
      run: |
        date


    - name: Check output
      run: |
        echo "OUTPUT: $OUTPUT"
      env:
        OUTPUT: ${{needs.first_job.outputs.matrix_order}}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Version
      run: terraform --version

    - name: Terraform fmt
      run: |
        terraform -chdir=$GITHUB_WORKSPACE/terraform/${{ matrix.stage }} fmt -check -recursive

    - name: Ended
      run: |
        date
